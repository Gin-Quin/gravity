A **request** trigger the following events:

1. `onRequestSend` *(client)* A request is sent by the client.
2. `onRequestReceive` *(server)* The request is received by the server.
3. `authorize` *(server)* The request is authorized or not.
4. `onResponseSend` *(server)* A response is sent by the server.
5. `onResponseReceive` *(client)* The response is received by the client.

<br>

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576.692138671875 403.95518493652344" width="100%">
  <g stroke-linecap="round"><g transform="translate(318.4370006030615 93.5234350146954) rotate(0 12.978001062782027 53.71969838940424)"><path d="M-1.09 -0.66 C8.61 34.62, 17.94 72.19, 25.07 107.88 M-0.44 0.27 C9.12 29.77, 15.31 60.56, 27.04 108.1" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(318.4370006030615 93.5234350146954) rotate(0 12.978001062782027 53.71969838940424)"><path d="M25.81 109.72 L18.65 96.56 L30 93.21 L28.63 109.38" stroke="none" stroke-width="0" fill="#000000" fill-rule="evenodd"></path><path d="M26.23 107.61 C23.88 102.64, 21.09 99.6, 16.86 96.53 M26.71 108.31 C25 104.78, 21.52 101.96, 18.34 96.7 M17.29 96.4 C20.62 96.06, 24.84 93.13, 31.25 94.19 M18.3 96.34 C20.74 96.26, 24.6 95.08, 29.95 94 M29.28 93.86 C29.36 97.51, 26.89 105.22, 26.73 108.46 M30.33 93.81 C28.85 98.5, 27.81 102.61, 27.57 107.63 M27.04 108.1 C27.04 108.1, 27.04 108.1, 27.04 108.1 M27.04 108.1 C27.04 108.1, 27.04 108.1, 27.04 108.1" stroke="#000000" stroke-width="1" fill="none"></path></g></g><g transform="translate(239.267578125 31.710128784179688) rotate(0 38.5 18)"><text x="0" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#0fb9de" text-anchor="start" style="white-space: pre;" direction="ltr">Client</text></g><g transform="translate(240.54229736328125 235.2177276611328) rotate(0 44 18)"><text x="0" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#fd5591" text-anchor="start" style="white-space: pre;" direction="ltr">Server</text></g><g transform="translate(226.96551513671875 368.95518493652344) rotate(0 61 12.5)"><text x="61" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#fd5591" text-anchor="middle" style="white-space: pre;" direction="ltr">3. Authorize</text></g><g transform="translate(30.9022216796875 174.9910125732422) rotate(0 90.5 12.5)"><text x="90.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#fd5591" text-anchor="middle" style="white-space: pre;" direction="ltr">4. onResponseSend</text></g><g transform="translate(10 77.08723449707031) rotate(0 104 12.5)"><text x="104" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#0fb9de" text-anchor="middle" style="white-space: pre;" direction="ltr">5. onResponseReceive</text></g><g stroke-linecap="round" transform="translate(186.11016845703125 216.90708923339844) rotate(0 99.10494995117188 36.86724853515625)"><path d="M1.75 -1.12 C60.1 1, 117.13 0.86, 199.71 -0.01 M0.75 -0.01 C60.32 1.94, 119.8 0.38, 198.5 -0.32 M197.6 1.53 C196.34 18.41, 196.49 38.88, 199 74.46 M198.9 -0.46 C197.8 16.02, 197.93 32.84, 197.32 73.25 M197.18 71.95 C127.91 73.88, 54.77 72.7, -0.9 73.37 M198.01 74.3 C151.06 73.2, 101.37 73.2, -0.78 73.46 M1.93 73.1 C-1.02 55.03, 1.83 37.87, -1.03 -0.42 M-0.56 74.12 C-0.42 47.81, 1.09 19.85, -0.31 -0.85" stroke="#000000" stroke-width="1" fill="none"></path></g><g stroke-linecap="round" transform="translate(204.0133056640625 10) rotate(0 75.912841796875 37.236106872558594)"><path d="M52.76 1.48 C63.59 -0.76, 79.79 -0.9, 92.08 0.29 C104.36 1.47, 117.18 4.66, 126.46 8.59 C135.73 12.51, 143.58 17.93, 147.73 23.84 C151.88 29.75, 153.58 37.98, 151.34 44.03 C149.1 50.08, 142.21 55.67, 134.28 60.15 C126.36 64.63, 115.03 68.71, 103.79 70.91 C92.54 73.11, 79.01 74, 66.83 73.36 C54.64 72.72, 40.65 70.66, 30.66 67.09 C20.67 63.51, 12.06 57.26, 6.88 51.89 C1.7 46.51, -1.33 40.68, -0.41 34.84 C0.51 29, 5.59 21.82, 12.39 16.83 C19.2 11.85, 32.83 7.43, 40.42 4.92 C48.01 2.41, 54.53 2.47, 57.95 1.77 C61.37 1.08, 60.7 0.36, 60.96 0.75 M74.82 -0.46 C86.39 -0.98, 98.98 2.2, 109.51 5.21 C120.05 8.23, 130.98 12.75, 138.06 17.64 C145.13 22.53, 151.04 28.92, 151.96 34.56 C152.87 40.21, 148.7 46.15, 143.54 51.52 C138.38 56.88, 130.56 62.98, 121 66.75 C111.45 70.52, 98.48 73.45, 86.23 74.15 C73.97 74.84, 59.13 72.98, 47.47 70.92 C35.82 68.86, 23.98 66.18, 16.31 61.79 C8.64 57.4, 3.17 50.67, 1.45 44.58 C-0.27 38.5, 1.95 31.27, 6.01 25.26 C10.06 19.26, 16.66 12.68, 25.76 8.54 C34.87 4.41, 52.94 1.82, 60.64 0.47 C68.34 -0.88, 69.72 0.19, 71.96 0.45 C74.2 0.72, 73.73 1.46, 74.08 2.06" stroke="#000000" stroke-width="1" fill="none"></path></g><g stroke-linecap="round"><g transform="translate(328.9124302234186 301.58714294433594) rotate(0 -8.853730902625045 27.39885976165533)"><path d="M1.84 1.06 C-3.53 12.83, -9.08 25.61, -18.98 55.27 M0.15 -0.47 C-3.41 11.94, -9.16 23.99, -19.55 55.05" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(328.9124302234186 301.58714294433594) rotate(0 -8.853730902625045 27.39885976165533)"><path d="M-19.25 55.24 L-21.18 38.58 L-8.58 45.33 L-19.03 56.14" stroke="none" stroke-width="0" fill="#000000" fill-rule="evenodd"></path><path d="M-18.17 55.84 C-18.95 50.9, -19.83 46.76, -20.48 40.86 M-19.43 54.7 C-19.54 51.6, -20.87 48.19, -20.9 40.7 M-22.11 40.83 C-17.64 40.91, -14 42.61, -10.05 44.8 M-20.92 39.81 C-16.7 41.15, -11.21 43.33, -9.09 43.78 M-8.58 43.65 C-11.72 47.62, -17.54 50.47, -19.39 54.35 M-9.44 43.95 C-13.37 47.62, -16.94 52.5, -18.89 55.08 M-19.55 55.05 C-19.55 55.05, -19.55 55.05, -19.55 55.05 M-19.55 55.05 C-19.55 55.05, -19.55 55.05, -19.55 55.05" stroke="#000000" stroke-width="1" fill="none"></path></g></g><g stroke-linecap="round"><g transform="translate(270.0489291443222 353.4542718231678) rotate(0 -9.694988199872967 -23.163457058370113)"><path d="M0.84 0.98 C-7.02 -12.54, -11.9 -25.07, -19.61 -47.31 M0.8 0.03 C-4.64 -10.89, -9.25 -21.14, -20.23 -45.39" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(270.0489291443222 353.4542718231678) rotate(0 -9.694988199872967 -23.163457058370113)"><path d="M-18.36 -46.73 L-7.51 -37.31 L-18.51 -28.77 L-20.63 -43.68" stroke="none" stroke-width="0" fill="#000000" fill-rule="evenodd"></path><path d="M-19.6 -44.65 C-18.11 -42, -14.37 -38.82, -9.13 -36.98 M-19.63 -45.37 C-17.82 -43.49, -15.42 -41.23, -9.59 -35.54 M-7.66 -35.52 C-12.13 -34.22, -14.86 -32.59, -19.19 -30.28 M-9.31 -35.92 C-12.35 -34.68, -15.2 -32.39, -20.21 -30.6 M-20.17 -30.25 C-20.46 -35.94, -19.93 -38.42, -19.84 -44.58 M-19.68 -30.02 C-20.5 -36.35, -19.59 -41.99, -20.95 -45.16 M-20.23 -45.39 C-20.23 -45.39, -20.23 -45.39, -20.23 -45.39 M-20.23 -45.39 C-20.23 -45.39, -20.23 -45.39, -20.23 -45.39" stroke="#000000" stroke-width="1" fill="none"></path></g></g><g stroke-linecap="round"><g transform="translate(222.56342635654346 200.6621551513672) rotate(0 14.398049883920862 -53.78677545682103)"><path d="M0.37 0.69 C10.07 -39.47, 21.55 -78.92, 29.01 -107.18 M-0.22 0.13 C10.28 -38.61, 21.19 -74.79, 27.36 -108.26" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(222.56342635654346 200.6621551513672) rotate(0 14.398049883920862 -53.78677545682103)"><path d="M28.38 -108.34 L31.88 -91.76 L18.16 -98.29 L27.3 -109.75" stroke="none" stroke-width="0" fill="#000000" fill-rule="evenodd"></path><path d="M27.63 -107.75 C29.25 -102.82, 31.33 -97.46, 31.22 -92.75 M27.19 -108.17 C27.98 -103.99, 29.99 -98.06, 29.97 -93.56 M31.34 -94.2 C27.8 -93.84, 23.95 -95.1, 18.36 -97.1 M31.01 -93.29 C26.16 -94.4, 21.62 -94.99, 17.83 -95.75 M19.02 -97.69 C21.87 -99.82, 21.9 -103.45, 28.78 -108.18 M18.68 -96.21 C20.76 -100.02, 23.35 -102.49, 26.86 -107.67 M27.36 -108.26 C27.36 -108.26, 27.36 -108.26, 27.36 -108.26 M27.36 -108.26 C27.36 -108.26, 27.36 -108.26, 27.36 -108.26" stroke="#000000" stroke-width="1" fill="none"></path></g></g><g transform="translate(347.732666015625 76.24742126464844) rotate(0 83 12.5)"><text x="0" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#0fb9de" text-anchor="start" style="white-space: pre;" direction="ltr">1. onRequestSend</text></g><g transform="translate(363.692138671875 175.4894561767578) rotate(0 101.5 12.5)"><text x="0" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#fd5591" text-anchor="start" style="white-space: pre;" direction="ltr">2. onRequestReceive</text></g></svg>


## onRequestSend

This event happens just before the client sends a new request.

The callback signature is:

```ts
type OnRequestSend = (request: RequestInit) => unknown
```

> The `RequestInit` type is a global DOM type also available in Node.

This event can be used to add custom headers to the request.

As as client event, you define the callback as a [defineApi](/documentation/usage/project-structure#/api.ts) option:

```ts
export const { api, useApi } = defineApi<services>({
  onRequestSend: (request) => {
    // ... do stuff
    request.headers.append('my-custom-header', 'foo')
  }
})
```


## onRequestReceive 

This event happens when a request is received by the server.

It is at this point that the **context** of the request is created. Usually the callback of this event will read the different headers of the request and create the right context.

The callback signature is:

```ts
type OnResponseReceive<Context> =
  (request: Request) => Context | Promise<Context>
```

> The [Request](https://developer.mozilla.org/en-US/docs/Web/API/Request/Request) type is a global DOM type also available in Node.


As as server event, you define the callback in the [gravity handler](/documentation/usage/project-structure#server-entry-file):

```ts
export const handler = gravity<Context>({
  services,
  schema,

  onRequestReceive: (request) => {
    // do stuff, like reading headers
    const context: Context = ...
    return context
  }
})
```

> If your `Context` type is different than `undefined`, you **must** define a `onRequestReceive` callback that returns a context from a request.
>
> If you forget to define onRequestReceive, you'll have a type error.

## authorize

Once a request is received and its context is created, you can decide to authorize or not its resolution via this event.

The callback signature is:

```ts
type Authorize<Context> = (parameters: {
  context: Context;
  service: ServiceConstructor;
  path: string[];
}) => any;
```

If you don't want a request to be authorized, throw an error inside the callback.

As as server event, you define the callback in the [gravity handler](/documentation/usage/project-structure#server-entry-file):

```ts
import { ServerError } from "@digitak/gravity"

export const handler = gravity<Context>({
  services,
  schema,

  authorize: ({ context, service, path }) => {
    if (service == services.math) {
      throw new ServerError("unauthorized", {
        status: 500,
        message: "You are not authorized to access this top-secret service.",
      })
    }
  }
})
```

## onResponseSend

This callback happens just before the server send a response the client.

The callback signature is:

```ts
type OnResponseSend = (response: Response) => unknown
```

As as server event, you define the callback in the [gravity handler](/documentation/usage/project-structure#server-entry-file):

```ts
import { ServerError } from "@digitak/gravity"

export const handler = gravity<Context>({
  services,
  schema,

  onServerSend: (response) => {
    console.log("Sending response", response)
  }
})
```

## onResponseReceive

This event happens when the client receives a response from the server.


The callback signature is:

```ts
type OnResponseReceive = (response: Response) => unknown
```

> The [Response](https://developer.mozilla.org/en-US/docs/Web/API/Response) type is a global DOM type also available in Node.

A typical use case of this event is to handle errors.

As as client event, you define the callback as a [defineApi](/documentation/usage/project-structure#/api.ts) option:

```ts
export const { api, useApi } = defineApi<services>({
  onResponseReceive: (response) => {
    if (response.status < 200 && response.status >= 300) {
      console.error("Could not resolve the request", response)
    }
  }
})
```

